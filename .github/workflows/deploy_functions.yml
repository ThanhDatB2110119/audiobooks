# .github/workflows/deploy_functions.yml

name: Deploy Supabase Functions (from developer branch)

on:
  # ======================= THAY ĐỔI QUAN TRỌNG TẠI ĐÂY =======================
  # Workflow này sẽ được kích hoạt mỗi khi có code mới được đẩy lên
  # nhánh 'developer'.
  push:
    branches:
      - development # <-- Sửa từ 'main' thành 'development'
    paths:
      # Workflow cũng chỉ chạy nếu có sự thay đổi bên trong thư mục 'supabase/functions/'.
      # Điều này giúp tiết kiệm tài nguyên, không chạy lại khi bạn chỉ sửa code Flutter.
      - "supabase/functions/**"
  # ========================================================================

  # Dòng này cho phép bạn có thể chạy workflow này một cách thủ công từ
  # tab "Actions" trên GitHub, rất tiện lợi để deploy lại khi cần.
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        # Bước này sẽ checkout code từ nhánh 'developer'
        uses: actions/checkout@v3

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Supabase Functions
        env:
          # Sử dụng các secret bạn đã tạo trên GitHub (SUPABASE_PROJECT_ID, SUPABASE_ACCESS_TOKEN)
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

        run: |
          # Lệnh deploy vẫn giữ nguyên
          echo "Deploying function..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_ID
